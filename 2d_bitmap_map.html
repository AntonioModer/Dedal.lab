

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Daedalus 04 BitmapPathfinding javascript example</title>
</head>
<body bgcolor="#000000">

<script src="src/DDLS.js"></script>
<script src="src/math/Point.js"></script>
<script src="src/math/Matrix2D.js"></script>
<script src="src/math/RandGenerator.js"></script>
<script src="src/data/Edge.js"></script>
<script src="src/data/Face.js"></script>
<script src="src/data/Vertex.js"></script>
<script src="src/data/Object.js"></script>
<script src="src/data/Segment.js"></script>
<script src="src/data/Shape.js"></script>
<script src="src/data/Iterators.js"></script>
<script src="src/math/Geom2D.js"></script>
<script src="src/data/Mesh.js"></script>
<script src="src/data/Graph.js"></script>
<script src="src/math/Potrace.js"></script>
<script src="src/math/Tools.js"></script>
<script src="src/ai/AStar.js"></script>
<script src="src/ai/EntityAI.js"></script>
<script src="src/ai/Funnel.js"></script>
<script src="src/ai/PathFinder.js"></script>
<script src="src/ai/FieldOfView.js"></script>
<script src="src/ai/trajectory/LinearPathSampler.js"></script>
<script src="src/ai/trajectory/PathIterator.js"></script>
<script src="src/factories/RectMesh.js"></script>
<script src="src/factories/BitmapObject.js"></script>
<script src="src/factories/BitmapMesh.js"></script>
<script src="src/ai/Heroe.js"></script>
<script src="src/ai/World.js"></script>

<script src="js/ddls_plugins/SimpleView.js"></script>
<script>

var DEMO = function() {
    this.newPath = false;
    this.mesh = DDLS.RectMesh(1024,780);
    this.imageLoader = new DDLS.ImageLoader(["assets/galapagosBW3.png","assets/galapagosColor.png"],this.onLoaded.bind(this));
};


DEMO.prototype = {
    onLoaded: function() {
        var images = this.imageLoader.images;
        this.img = images.get("galapagosBW3.png");

        this.world = new DDLS.World(this.img.width, this.img.height);
        this.basicCanvas = new DDLS.BasicCanvas(this.img.width, this.img.height);
        this.view = new DDLS.SimpleView(this.basicCanvas);
        
        this.ctx = this.basicCanvas.ctx;
        this.w = this.img.width;
        this.h = this.img.height;
        this.ctx.drawImage(this.img,0,0,this.w,this.h);
        var pixels = DDLS.fromImageData(this.ctx.getImageData(0,0,this.w,this.h));
        this.ctx.clearRect(0,0,this.w,this.h);
        this.img = images.get("galapagosColor.png");
        this.ctx.drawImage(this.img,0,0,this.w,this.h);
        this.object = DDLS.BitmapObject.buildFromBmpData(pixels,1.8);
        this.object.x = 0;
        this.object.y = 0;

        this.world.mesh.insertObject(this.object);
        this.view.drawMesh(this.world.mesh,true);

        this.world.addHeroe({ x:50, y:50, r:4, speed:10 });

        /*this.entityAI = new DDLS.EntityAI();
        this.entityAI.radius = 4;
        this.entityAI.x = 50;
        this.entityAI.y = 50;
        this.pathfinder = new DDLS.PathFinder();
        this.pathfinder.entity = this.entityAI;
        this.pathfinder.mesh = this.mesh;
        this.path = [];
        this.pathSampler = new DDLS.LinearPathSampler();
        this.pathSampler.entity = this.entityAI;
        this.pathSampler.samplingDistance = 10;
        this.pathSampler.path = this.path;*/
        var bc = this.basicCanvas.canvas;
        bc.onmousedown = function(e){this.onMouseDown(e)}.bind(this);
      //  bc.onmouseup = function(e){this.onMouseUp(e)}.bind(this);
       // bc.onmousemove = function(e){this.onMouseMove(e)}.bind(this);
        //this.basicCanvas.onEnterFrame = function(e){this.onEnterFrame(e).bind(this)};
        this.render();
    }
    ,onMouseMove: function(e) {

        this.view.drawMesh(this.world.mesh,true);
        var p = e;
        this.mx = p.clientX;
        this.my = p.clientY;

        this.world.heroes[0].setTarget(e.clientX, e.clientY);
    }
    ,onMouseUp: function(event) {
       // this.newPath = false;
    }
    ,onMouseDown: function(e) {
       // this.newPath = true;
        this.view.drawMesh(this.world.mesh,true);
        var rect = e.target.getBoundingClientRect();
        this.world.heroes[0].setTarget(e.clientX - rect.left, e.clientY - rect.top);
    }
    ,render: function() {
        requestAnimationFrame( this.render.bind(this) );
        this.world.update();
        var i = this.world.heroes.length, h;
        while(i--){
            h = this.world.heroes[i];
            if(h.newPath) this.view.drawPath( h.entity.path );
            this.view.drawEntity(h.entity);
        }
        /*if(this.newPath) {
            this.ctx.clearRect(0,0,this.w,this.h);
            this.ctx.drawImage(this.img,0,0,this.w,this.h);
            this.view.drawMesh(this.mesh,false);
            this.pathfinder.findPath(this.mx,this.my,this.path);
            this.view.drawPath(this.path);
            this.pathSampler.reset();
        }
        if(this.pathSampler.hasNext) this.pathSampler.next();
        this.view.drawEntity(this.entityAI);*/
    }
    ,onKeyDown: function(event) {
        if(event.keyCode == 32) event.preventDefault(); else if(event.keyCode == 13) event.preventDefault();
    }
};

new DEMO();
</script>
</body>